name: NixOS Configuration Check
on:
  push:
    branches:
      - main
      - master
  pull_request:
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Mock hardware-configuration.nix
        # This creates a dummy configuration at /etc/nixos/hardware-configuration.nix
        # to satisfy the import in your flake.
        run: |
          sudo mkdir -p /etc/nixos
          cat <<EOF | sudo tee /etc/nixos/hardware-configuration.nix
          { config, lib, pkgs, modulesPath, ... }:
          {
            imports = [ ];
            boot.initrd.availableKernelModules = [ "xhci_pci" "ahci" "usb_storage" "sd_mod" ];
            boot.initrd.kernelModules = [ ];
            boot.kernelModules = [ "kvm-intel" ];
            boot.extraModulePackages = [ ];

            # Minimal root filesystem definition to satisfy NixOS evaluation
            fileSystems."/" = {
              device = "/dev/disk/by-uuid/00000000-0000-0000-0000-000000000000";
              fsType = "ext4";
            };

            swapDevices = [ ];
            nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
          }
          EOF
      - name: Check Flake Health
        # Checks flake.lock for deprecated inputs and general health
        uses: DeterminateSystems/flake-checker-action@v9
      - name: Check Flake Syntax
        # Uses --impure to allow access to the /etc/nixos file we just created
        run: nix flake check --impure
      - name: Run Statix (Linting)
        run: nix run nixpkgs#statix -- check || true
      - name: Run Deadnix (Dead Code Detection)
        run: nix run github:astro/deadnix --
      - name: Dry Build (Verify Configuration Evaluates)
        run: nix build .#nixosConfigurations.nixos.config.system.build.toplevel --dry-run --impure
      - name: Security Scan
        run: nix run nixpkgs#vulnix -- --system
      - name: Check Formatting (Alejandra)
        # Fails if code is not formatted. Run `nix run nixpkgs#alejandra -- .` locally to fix.
        run: nix run nixpkgs#alejandra -- --check .
