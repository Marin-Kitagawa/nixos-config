name: NixOS Configuration Check
on:
  push:
    branches:
      - main
      - master
  pull_request:
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Mock hardware-configuration.nix
        # Creates a dummy file so Nix flake check evaluation succeeds.
        # Adjust the path below if your hardware-configuration.nix is expected somewhere else
        # inside your repository (e.g., ./hosts/my-pc/hardware-configuration.nix).
        run: |
          sudo mkdir -p /etc/nixos
          echo '{ config, lib, pkgs, modulesPath, ... }: { imports = [ (modulesPath + "/installer/scan/not-detected.nix") ]; boot.initrd.availableKernelModules = [ "xhci_pci" "ahci" "usb_storage" "sd_mod" ]; boot.initrd.kernelModules = [ ]; boot.kernelModules = [ "kvm-intel" ]; boot.extraModulePackages = [ ]; fileSystems."/" = { device = "/dev/disk/by-uuid/6bc66c02-0e2b-4f4b-9deb-3dfe6123d09c"; fsType = "btrfs"; options = [ "subvol=@" ]; }; fileSystems."/boot" = { device = "/dev/disk/by-uuid/FB39-BE79"; fsType = "vfat"; options = [ "fmask=0022" "dmask=0022" ]; }; swapDevices = [ ]; # Enables DHCP on each ethernet and wireless interface. In case of scripted networking (the default) this is the recommended approach. When using systemd-networkd it's still possible to use this option, but it's recommended to use it in conjunction with explicit per-interface declarations with `networking.interfaces.<interface>.useDHCP`. networking.useDHCP = lib.mkDefault true; networking.interfaces.enp2s0.useDHCP = lib.mkDefault true; networking.interfaces.wlp3s0.useDHCP = lib.mkDefault true; nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux"; hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware; }' | sudo tee /etc/nixos/hardware-configuration.nix
      - name: Check Flake Syntax
        run: nix flake check --impure
      - name: Run Statix (Linting)
        run: nix run nixpkgs#statix -- check
      - name: Run Deadnix (Dead Code Detection)
        run: nix run github:astro/deadnix -- .
      - name: Dry Build (Verify Configuration Evaluates)
        # This attempts to build the system configuration without creating a VM
        # It ensures that your configuration.nix logic is sound.
        run: nix build .#nixosConfigurations.nixos.config.system.build.toplevel --dry-run
