name: NixOS Configuration Check
on:
  push:
    branches:
      - main
      - master
  pull_request:
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      - name: Mock hardware-configuration.nix
        # Creates a dummy file so Nix flake check evaluation succeeds.
        # Adjust the path below if your hardware-configuration.nix is expected somewhere else
        # inside your repository (e.g., ./hosts/my-pc/hardware-configuration.nix).
        run: |
          sudo mkdir -p /etc/nixos
          echo '{ config, lib, pkgs, modulesPath, ... }: { imports = [ (modulesPath + "/installer/scan/not-detected.nix") ]; boot.initrd.availableKernelModules = [ "xhci_pci" "nvme" "usb_storage" "sd_mod" ]; boot.initrd.kernelModules = [ ]; boot.kernelModules = [ "kvm-intel" ]; # Or "kvm-amd" for AMD boot.extraModulePackages = [ ]; fileSystems."/" = { device = "/dev/disk/by-uuid/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"; fsType = "ext4"; }; fileSystems."/boot" = { device = "/dev/disk/by-uuid/XXXX-XXXX"; fsType = "vfat"; }; swapDevices = [ { device = "/dev/disk/by-uuid/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"; } ]; Enables DHCP on each ethernet and wireless interface. networking.useDHCP = lib.mkDefault true; nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux"; hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware; }' | sudo tee /etc/nixos/hardware-configuration.nix
      - name: Check Flake Syntax
        run: nix flake check --impure
      - name: Run Statix (Linting)
        run: nix run nixpkgs#statix -- check
      - name: Run Deadnix (Dead Code Detection)
        run: nix run github:astro/deadnix -- .
      - name: Dry Build (Verify Configuration Evaluates)
        # This attempts to build the system configuration without creating a VM
        # It ensures that your configuration.nix logic is sound.
        run: nix build .#nixosConfigurations.nixos.config.system.build.toplevel --dry-run
